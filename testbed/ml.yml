version: '3.7'

services:
  server:
    hostname: server
    image: bfl-node
    entrypoint: /root/run_server.sh
    deploy:
      replicas: $SERVERS
    environment:
      # - IPFS_API=/ip4/127.0.0.1/tcp/5001
      - IPFS_API=/dns/host.docker.internal/tcp/5001
      # - IPFS_API=None
      - CONTRACT=$CONTRACT
      - MINERS=$MINERS
      - DATASET=$DATASET
    volumes:
      # Use the following volume for a public validation dataset:
      - './datasets/$DATASET/$CLIENTS:/root/dataset'
      # - './datasets/$DATASET/$SERVERS:/root/dataset'
      - ../build/contracts/Different.json:/root/abi.json
    extra_hosts:
    - "host.docker.internal:host-gateway"

  client:
    hostname: client
    image: bfl-node
    # entrypoint: ["tail", "-f", "/dev/null"]
    entrypoint: /root/run_client.sh
    deploy:
      replicas: $CLIENTS
    environment:
      # - IPFS_API=/ip4/127.0.0.1/tcp/5001
      - IPFS_API=/dns/host.docker.internal/tcp/5001
      # - IPFS_API=None
      - CONTRACT=$CONTRACT
      - PEDERSEN_CONTRACT=$PEDERSEN_CONTRACT
      - MINERS=$MINERS
      - DATASET=$DATASET
    volumes:
      - './datasets/$DATASET/$CLIENTS:/root/dataset'
      - '../build/contracts/Different.json:/root/abi.json'
      - '../build/contracts/PedersenContract.json:/root/ZKP/pedersen_abi.json'
    extra_hosts:
    - "host.docker.internal:host-gateway"

networks:
  default:
    external:
      name: bflnet
